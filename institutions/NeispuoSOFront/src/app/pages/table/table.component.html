<div class="wrapper-table">
  <form [formGroup]="parentGroup" *ngIf="array.controls.length">
    <mat-card class="section-card card-table">
      <mat-card-header class="no-color">
        <mat-card-title *ngIf="table.label"><span>{{ table.label }}</span></mat-card-title>
        <div class="search-container" *ngIf="table.searchable !== false && table.searchType !== 'column'">
          <mat-icon>search</mat-icon>
          <input matInput (keyup)="getData(true)" #input />
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="mat-elevation-z8">
          <mat-multi-sort-table-settings *ngIf="table.sortable !== false && tableData.sortDirs.length" [tableData]="tableData" sortToolTip="Промяна на реда на сортиране"> </mat-multi-sort-table-settings>
          <div class="table-container">
            <app-help *ngIf="table.help" [helpText]="table.help"></app-help>
            <table mat-table [dataSource]="tableData.dataSource" matMultiSort (matSortChange)="onSort()" class="l-custom-table" [trackBy]="trackById" [formArrayName]="table.name" [ngClass]="{'no-sort': table.sortable === false, 'table-with-buttons': tableWithButtons(), 'table-one-button': tableWithOneButton()}">
              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="custom-tr-for-th"></tr>
              <ng-container *ngIf="table.searchable !== false && table.searchType === 'column'">
                <tr mat-header-row *matHeaderRowDef="displayedFilterColumns; sticky: true" class="custom-tr-for-filter"></tr>
              </ng-container>
              <div class="div-row-in-table" *matRowDef="let row; columns: displayedColumns; let i = index" [ngClass]="{'opened-info': row.opened}">
                <tr mat-row [ngClass]="{'action': actionAvailable(row, i)}"></tr>
                <app-fast-preview *ngIf="row.opened" [columnNumber]="columnNumber()" [formName]="table.formName"></app-fast-preview>
              </div>
              <ng-container matColumnDef="reorder" *ngIf="!multiAddMode && table.reorder">
                <th mat-header-cell *matHeaderCellDef class="order-column"></th>
                <td mat-cell *matCellDef="let row; let i = index" class="order-column">
                  <div class="order-buttons">
                    <button class="custom-icon-expand reorder-button-custom" *ngIf="!((tableData.pageIndex === 0 || tableData.pageIndex === undefined) && i === 0)" [disabled]="reorderDisabled()" (click)="swapUp(i)" matTooltipClass="l-custom-tooltip-m-l-50" matTooltip="премести нагоре" type="button">
                      <mat-icon>expand_less</mat-icon>
                    </button>
                    <button class="custom-icon-expand reorder-button-custom" *ngIf="!isLastRecord(i)" [disabled]="reorderDisabled()" (click)="swapDown(i)" matTooltipClass="l-custom-tooltip-m-l-50" matTooltip="премести надолу" type="button">
                      <mat-icon>expand_more</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="reorder-filter" *ngIf="!multiAddMode && table.reorder && table.searchable !== false && table.searchType === 'column'">
                <th mat-header-cell *matHeaderCellDef></th>
              </ng-container>
              <ng-container matColumnDef="check" *ngIf="multiAddMode">
                <th mat-header-cell *matHeaderCellDef>
                  <div class="button-container">
                    <mat-checkbox *ngIf="table.searchType !== 'column'" color="primary" class="m-l-8" [checked]="allChecked()" (click)="onCheckAll($event)"></mat-checkbox>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row">
                  <div class="button-container">
                    <mat-checkbox color="primary" [checked]="isChecked(row)" (click)="onCheck($event, row)"></mat-checkbox>
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="check-filter" *ngIf="multiAddMode && table.searchable !== false && table.searchType === 'column'">
                <th mat-header-cell *matHeaderCellDef>
                  <div class="button-container">
                    <mat-checkbox color="primary" class="m-l-8" [checked]="allChecked()" (click)="onCheckAll($event)"></mat-checkbox>
                  </div>
                </th>
              </ng-container>
              <ng-container *ngFor="let field of table.fields" [matColumnDef]="field.name" sticky>
                <th mat-header-cell *matHeaderCellDef [mat-multi-sort-header]="field.name" [style.width.%]="field.width">
                  <div class="th-container-header" [ngClass]="{'sortable': table.sortable !== false}">
                    <span class="name-th-span">{{ field.label }}</span>
                    <mat-icon class="sort-custom-icon" matTooltip="сортиране" *ngIf="table.sortable !== false">import_export</mat-icon>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row; let i = index" [style.width.%]="field.width" (click)="performAction(row, i)">
                  <span class="value-td" *ngIf="field.type !== type.Date && (field.disabled !== false || mode === modes.View || multiAddMode)">{{
                    getFieldVal(row, field.name) }}</span>
                  <span class="value-td" *ngIf="field.type === type.Date && (field.disabled !== false || mode === modes.View || multiAddMode)">{{
                    getFieldVal(row, field.name) | date: "dd.MM.yyyy" }}</span>
                  <ng-container dynamicField *ngIf="field.disabled === false && mode !== modes.View && !multiAddMode" [field]="getField(row, field.name)" [group]="getFormGroup(row)" [mode]="mode" [showLabel]="false"></ng-container>
                </td>
              </ng-container>
              <ng-container *ngIf="table.searchable !== false && table.searchType === 'column'">
                <ng-container *ngFor="let field of table.fields" [matColumnDef]="field.name + 'filter'" sticky>
                  <th mat-header-cell *matHeaderCellDef>
                    <div class="search-field-th">
                      <mat-icon class="search-custom-icon">search</mat-icon>
                      <mat-form-field [formGroup]="filterGroup" class="block-field default-field padding-0 mat-form-field-search-container" floatLabel="never">
                        <input matInput (keyup)="getData(true)" [formControlName]="field.name" type="text" />
                      </mat-form-field>
                    </div>
                  </th>
                </ng-container>
              </ng-container>
              <ng-container matColumnDef="actions" *ngIf="tableWithButtons()">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let row; let i = index">
                  <div class="button-container">
                    <button mat-raised-button *ngIf="hasEditButton(row, i)" (click)="navigate(row)" matTooltip="редакция" class="edit-button-td" type="button">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-raised-button *ngIf="table.action === 'preview' || hasFakePreview(row)" (click)="navigate(row)" matTooltip="преглед" class="view-button-td" type="button">
                      <mat-icon>remove_red_eye</mat-icon>
                    </button>
                    <button mat-raised-button *ngIf="table.action === 'fastPreview'" (click)="fastPreview(row)" [matTooltip]="row.opened ? 'затвори' : 'преглед'" class="view-button-td" type="button">
                      <mat-icon *ngIf="!row.opened">remove_red_eye</mat-icon>
                      <mat-icon *ngIf="row.opened">cancel</mat-icon>
                    </button>
                    <button mat-raised-button *ngIf="hasDeleteButton(row, i) && !multiAddMode" (click)="delete(row)" [disabled]="addNewRecord || row.opened" matTooltip="изтриване" class="delete-button-td" type="button">
                    </button>
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="actions-filter" *ngIf="tableWithButtons()">
                <th mat-header-cell *matHeaderCellDef></th>
              </ng-container>
            </table>
            <div *ngIf="addNewRecord" #newRecord class="add-new-column-container">
              <app-new-table-record [formName]="table.formName" [createParams]="table.createParams" [row]="row" [paramName]="table.paramName" [parentMode]="mode" [canSave]="table.action !== 'fakePreview'" (save)="onAddRecord($event)"></app-new-table-record>
            </div>
          </div>
        </div>
        <div class="footer-container-custom-table">
          <div class="l-pagination-container">
            <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" [length]="length" [pageIndex]="tableData.pageIndex" [pageSize]="25" (page)="tableData.onPaginationEvent($event)" showFirstLastButtons></mat-paginator>
          </div>
          <div class="wrapper-button-table-container" *ngIf="!multiAddMode">
            <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'staffList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewStaffMember()" matTooltip="Добави" type="button">
              <mat-icon>person_add</mat-icon> нов запис
            </button>
            <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'subjectInstitutionList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewSubjectInstitution()" matTooltip="Добави" type="button">+ нов запис</button>
            <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'nkpdList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewStaffPosition()" matTooltip="Добави" type="button">+ нов запис</button>
            <button *ngIf="hasNewRecordButton()" (click)="createNew()" mat-raised-button color="primary" class="add-record-btn" matTooltip="Добави" [disabled]="addNewRecord" type="button">+ нов запис</button>
            <button *ngIf="table.multiAdd && !isMonRuo && !isHistory && mode !== modes.View && (!isLocked || table.name === 'studentsAmendatoryList')" (click)="addRows()" mat-raised-button color="primary" class="add-record-btn" [disabled]="multiAddDisabled()" [matTooltip]="table.multiAdd.tooltip" type="button">
              <mat-icon>person_add</mat-icon> нов запис
            </button>
            <div class="div-right-container">
              <span class="save-order-btn" (click)="saveReorder()" matTooltip="запис на поредност" *ngIf="table.reorder && mode === modes.View">
                <mat-icon>save</mat-icon>
              </span>
              <span class="extract-excel-btn" (click)="exportExcel()" matTooltip="експорт в excel"><img class="icon-btn" src="../../../assets/images/excel.png" /></span>
              <span class="extract-pdf-btn" (click)="exportPdf()" matTooltip="експорт в pdf">
                <img class="icon-btn" src="../../../assets/images/pdf.png" />
              </span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </form>
  <ng-container *ngIf="!array.controls.length">
    <span>Няма намерени резултати</span>
    <div class="wrapper-button-table-container">
      <button *ngIf="hasNewRecordButton()" (click)="createNew()" mat-raised-button color="primary" class="add-record-btn" matTooltip="Добави запис" [disabled]="addNewRecord" type="button">+ нов запис</button>
      <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'staffList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewStaffMember()" matTooltip="Добави" type="button">
        <mat-icon>person_add</mat-icon> нов запис
      </button>
      <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'subjectInstitutionList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewSubjectInstitution()" matTooltip="Добави" type="button">+ нов запис</button>
      <button mat-raised-button color="primary" class="add-record-btn" *ngIf="formName === 'nkpdList' && !isMonRuo && !isHistory && !isLocked" (click)="createNewStaffPosition()" matTooltip="Добави" type="button">+ нов запис</button>
      <button *ngIf="table.multiAdd && !isMonRuo && !isHistory && !multiAddMode && mode !== modes.View && (!isLocked || table.name === 'studentsAmendatoryList')" (click)="addRows()" mat-raised-button color="primary" class="add-record-btn" [disabled]="multiAddDisabled()" [matTooltip]="table.multiAdd.tooltip" type="button">
        <mat-icon>person_add</mat-icon> нов запис
      </button>
    </div>
    <div *ngIf="addNewRecord" #newRecord class="add-new-column-container">
      <app-new-table-record [formName]="table.formName" [createParams]="table.createParams" [row]="row" [paramName]="table.paramName" [parentMode]="mode" [canSave]="table.action !== 'fakePreview'" (save)="onAddRecord($event)"></app-new-table-record>
    </div>
  </ng-container>
</div>
<app-loader *ngIf="isLoading"></app-loader>