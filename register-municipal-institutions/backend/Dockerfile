FROM node:14.17.4-alpine3.14

COPY ./ /rmi-be/
WORKDIR /rmi-be/

RUN mv /rmi-be/config/.env-example-docker /rmi-be/config/.env

## Build the project
RUN npm install
RUN npm install pm2 -g
RUN npm run prebuild
RUN npm run build

## NODE_ENV - development/staging/production
ENV NODE_ENV=development
ENV APP_PORT=3001

## DB
ENV DB_CLIENT=mssql
ENV DB_HOST=
ENV DB_PORT=
ENV DB_USERNAME=
ENV DB_PASSWORD=
ENV DB=

## BLOBS DB
ENV BLOBS_DB_CLIENT=mssql
ENV BLOBS_DB_HOST=
ENV BLOBS_DB_PORT=
ENV BLOBS_DB_USERNAME=
ENV BLOBS_DB_PASSWORD=
ENV BLOBS_DB=
ENV BLOBS_DB_CONNECTION=

## CORS
ENV CORS_DOMAINS=any
ENV CORS_METHODS="GET,PUT,POST,DELETE,PATCH,HEAD"
ENV CORS_ALLOWED_HEADERS=
ENV CORS_EXPOSED_HEADERS=
ENV CORS_CREDENTIALS=false
ENV CORS_MAX_AGE=
ENV CORS_PREFLIGHT_CONTINUE=false
ENV CORS_OPTIONS_SUCCESS_STATUS=204

## JWKS
ENV JWKS_ENDPOINT=

ENV AUTO_RUN_MIGRATIONS=false

## Blob
ENV HMAC_KEY=
ENV BLOB_SERVER_URL=

## USER MANAGEMENT

ENV AZURE_USERMNG_URL_CREATE_SCHOOL=
ENV AZURE_USERMNG_URL_DELETE_SCHOOL=

EXPOSE 3001

RUN chmod +x /rmi-be/docker-entrypoint.sh

ENTRYPOINT ["./docker-entrypoint.sh"]
