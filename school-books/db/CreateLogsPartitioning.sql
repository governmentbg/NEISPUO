PRINT 'Create Logs partitioning'
GO

USE [master]
GO

DECLARE @SQL NVARCHAR(MAX) = '';

SELECT @SQL = @SQL + '
    ALTER DATABASE [$(dbName)] ADD FILEGROUP [FG_Logs];

    ALTER DATABASE [$(dbName)] ADD FILE
    (
      NAME = [$(dbName)_Logs],
      FILENAME = ''' + CAST(SERVERPROPERTY('INSTANCEDEFAULTDATAPATH') AS NVARCHAR(MAX)) + '$(dbName)_Logs.ndf''
    )
    TO FILEGROUP [FG_Logs];';

EXEC sp_executesql @SQL
GO

USE [$(dbName)]
GO

-- create logs partition function

-- Partitions by quarter starting from Q1 2022
CREATE PARTITION FUNCTION pfLogs (datetime2)
AS RANGE RIGHT FOR VALUES (
  '20220101', '20220401', '20220701', '20221001',
  '20230101', '20230401', '20230701', '20231001',
  '20240101', '20240401', '20240701', '20241001',
  '20250101', '20250401', '20250701', '20251001',
  '20260101', '20260401', '20260701', '20261001',
  '20270101', '20270401', '20270701', '20271001',
  '20280101', '20280401', '20280701', '20281001',
  '20290101', '20290401', '20290701', '20291001'
);
GO

-- create logs partition scheme

CREATE PARTITION SCHEME psLogs
AS PARTITION pfLogs ALL TO ([FG_Logs]);
GO


-- Partitions by week from 2022-12-05 to 2025-12-31
-- 161 Partitions total
--
-- Autogenerated by the following script
-- Make sure to disable removal of new lines in Azure Data Studio/Management Studio
-- Azure Data Studio: Data > Query Editor > Results: Copy Remove New Line
-- Management Studio: Tools > Options > Query Results > SQL Server > Results to Grid > Retain CR/LR on copy or save
--
-- DECLARE @MinDate DATE = '20221205',
--         @MaxDate DATE = '20251231';

-- WITH Dates AS (
--     SELECT
--         TOP (DATEDIFF(DAY, @MinDate, @MaxDate) + 1)
--         [Date] = DATEADD(DAY, ROW_NUMBER() OVER(ORDER BY a.object_id) - 1, @MinDate)
--     FROM sys.all_objects a
--         CROSS JOIN sys.all_objects b
-- ),
-- IsoDates AS (
--     SELECT
--         [Date],
--         [Year] = DATEPART(yyyy, DATEADD(day, 26 - DATEPART(isowk, [Date]), [Date])),
--         [WeekNumber] = DATEPART(isowk, Date),
--         [Day] = (DATEPART(dw, Date) + (@@DATEFIRST - 1) - 1) % 7 + 1
--     FROM
--         Dates
-- ),
-- IsoWeeks AS (
--     SELECT DISTINCT
--         [WeekStart] = DATEADD(d, - [Day] + 1, [Date]),
--         [WeekEnd] = DATEADD(d, - [Day] + 7, [Date]),
--         [Year],
--         [WeekNumber]
--     FROM
--         IsoDates
-- )
-- SELECT
--     STRING_AGG(
--         '''' +
--         CONVERT(NVARCHAR(MAX), [WeekStart], 23) +
--         ''', -- ' +
--         CONVERT(NVARCHAR, [Year]) +
--         '/' +
--         RIGHT(CONCAT('00', CONVERT(NVARCHAR, [WeekNumber])),2),
--     CHAR(13) + CHAR(10))
-- FROM
--     IsoWeeks
-- GO

-- create logs weekly partition function

CREATE PARTITION FUNCTION pfLogsWeekly (datetime2)
AS RANGE RIGHT FOR VALUES (
    -- autogenerated
    '2022-12-05', -- 2022/49
    '2022-12-12', -- 2022/50
    '2022-12-19', -- 2022/51
    '2022-12-26', -- 2022/52
    '2023-01-02', -- 2023/01
    '2023-01-09', -- 2023/02
    '2023-01-16', -- 2023/03
    '2023-01-23', -- 2023/04
    '2023-01-30', -- 2023/05
    '2023-02-06', -- 2023/06
    '2023-02-13', -- 2023/07
    '2023-02-20', -- 2023/08
    '2023-02-27', -- 2023/09
    '2023-03-06', -- 2023/10
    '2023-03-13', -- 2023/11
    '2023-03-20', -- 2023/12
    '2023-03-27', -- 2023/13
    '2023-04-03', -- 2023/14
    '2023-04-10', -- 2023/15
    '2023-04-17', -- 2023/16
    '2023-04-24', -- 2023/17
    '2023-05-01', -- 2023/18
    '2023-05-08', -- 2023/19
    '2023-05-15', -- 2023/20
    '2023-05-22', -- 2023/21
    '2023-05-29', -- 2023/22
    '2023-06-05', -- 2023/23
    '2023-06-12', -- 2023/24
    '2023-06-19', -- 2023/25
    '2023-06-26', -- 2023/26
    '2023-07-03', -- 2023/27
    '2023-07-10', -- 2023/28
    '2023-07-17', -- 2023/29
    '2023-07-24', -- 2023/30
    '2023-07-31', -- 2023/31
    '2023-08-07', -- 2023/32
    '2023-08-14', -- 2023/33
    '2023-08-21', -- 2023/34
    '2023-08-28', -- 2023/35
    '2023-09-04', -- 2023/36
    '2023-09-11', -- 2023/37
    '2023-09-18', -- 2023/38
    '2023-09-25', -- 2023/39
    '2023-10-02', -- 2023/40
    '2023-10-09', -- 2023/41
    '2023-10-16', -- 2023/42
    '2023-10-23', -- 2023/43
    '2023-10-30', -- 2023/44
    '2023-11-06', -- 2023/45
    '2023-11-13', -- 2023/46
    '2023-11-20', -- 2023/47
    '2023-11-27', -- 2023/48
    '2023-12-04', -- 2023/49
    '2023-12-11', -- 2023/50
    '2023-12-18', -- 2023/51
    '2023-12-25', -- 2023/52
    '2024-01-01', -- 2024/01
    '2024-01-08', -- 2024/02
    '2024-01-15', -- 2024/03
    '2024-01-22', -- 2024/04
    '2024-01-29', -- 2024/05
    '2024-02-05', -- 2024/06
    '2024-02-12', -- 2024/07
    '2024-02-19', -- 2024/08
    '2024-02-26', -- 2024/09
    '2024-03-04', -- 2024/10
    '2024-03-11', -- 2024/11
    '2024-03-18', -- 2024/12
    '2024-03-25', -- 2024/13
    '2024-04-01', -- 2024/14
    '2024-04-08', -- 2024/15
    '2024-04-15', -- 2024/16
    '2024-04-22', -- 2024/17
    '2024-04-29', -- 2024/18
    '2024-05-06', -- 2024/19
    '2024-05-13', -- 2024/20
    '2024-05-20', -- 2024/21
    '2024-05-27', -- 2024/22
    '2024-06-03', -- 2024/23
    '2024-06-10', -- 2024/24
    '2024-06-17', -- 2024/25
    '2024-06-24', -- 2024/26
    '2024-07-01', -- 2024/27
    '2024-07-08', -- 2024/28
    '2024-07-15', -- 2024/29
    '2024-07-22', -- 2024/30
    '2024-07-29', -- 2024/31
    '2024-08-05', -- 2024/32
    '2024-08-12', -- 2024/33
    '2024-08-19', -- 2024/34
    '2024-08-26', -- 2024/35
    '2024-09-02', -- 2024/36
    '2024-09-09', -- 2024/37
    '2024-09-16', -- 2024/38
    '2024-09-23', -- 2024/39
    '2024-09-30', -- 2024/40
    '2024-10-07', -- 2024/41
    '2024-10-14', -- 2024/42
    '2024-10-21', -- 2024/43
    '2024-10-28', -- 2024/44
    '2024-11-04', -- 2024/45
    '2024-11-11', -- 2024/46
    '2024-11-18', -- 2024/47
    '2024-11-25', -- 2024/48
    '2024-12-02', -- 2024/49
    '2024-12-09', -- 2024/50
    '2024-12-16', -- 2024/51
    '2024-12-23', -- 2024/52
    '2024-12-30', -- 2025/01
    '2025-01-06', -- 2025/02
    '2025-01-13', -- 2025/03
    '2025-01-20', -- 2025/04
    '2025-01-27', -- 2025/05
    '2025-02-03', -- 2025/06
    '2025-02-10', -- 2025/07
    '2025-02-17', -- 2025/08
    '2025-02-24', -- 2025/09
    '2025-03-03', -- 2025/10
    '2025-03-10', -- 2025/11
    '2025-03-17', -- 2025/12
    '2025-03-24', -- 2025/13
    '2025-03-31', -- 2025/14
    '2025-04-07', -- 2025/15
    '2025-04-14', -- 2025/16
    '2025-04-21', -- 2025/17
    '2025-04-28', -- 2025/18
    '2025-05-05', -- 2025/19
    '2025-05-12', -- 2025/20
    '2025-05-19', -- 2025/21
    '2025-05-26', -- 2025/22
    '2025-06-02', -- 2025/23
    '2025-06-09', -- 2025/24
    '2025-06-16', -- 2025/25
    '2025-06-23', -- 2025/26
    '2025-06-30', -- 2025/27
    '2025-07-07', -- 2025/28
    '2025-07-14', -- 2025/29
    '2025-07-21', -- 2025/30
    '2025-07-28', -- 2025/31
    '2025-08-04', -- 2025/32
    '2025-08-11', -- 2025/33
    '2025-08-18', -- 2025/34
    '2025-08-25', -- 2025/35
    '2025-09-01', -- 2025/36
    '2025-09-08', -- 2025/37
    '2025-09-15', -- 2025/38
    '2025-09-22', -- 2025/39
    '2025-09-29', -- 2025/40
    '2025-10-06', -- 2025/41
    '2025-10-13', -- 2025/42
    '2025-10-20', -- 2025/43
    '2025-10-27', -- 2025/44
    '2025-11-03', -- 2025/45
    '2025-11-10', -- 2025/46
    '2025-11-17', -- 2025/47
    '2025-11-24', -- 2025/48
    '2025-12-01', -- 2025/49
    '2025-12-08', -- 2025/50
    '2025-12-15', -- 2025/51
    '2025-12-22', -- 2025/52
    '2025-12-29'  -- 2026/01
    -- end autogenerated
);
GO

-- create logs weekly partition scheme

CREATE PARTITION SCHEME psLogsWeekly
AS PARTITION pfLogsWeekly ALL TO ([FG_Logs]);
GO
