<sb-banner type="warning" [small]="true" *ngIf="!studentsWithGrades.length">
  Паралелката няма въведени ученици, които да изучават този предмет от учебния план.
</sb-banner>

<ng-container *ngIf="studentsWithGrades.length">
  <sb-transferred-students-banner
    class="mb-2.5"
    [small]="true"
    *ngIf="showTransferredStudentsBanner"
  ></sb-transferred-students-banner>

  <div class="sb-table-container mt-2.5 md:mt-0">
    <table
      class="sb-table table-grades"
      [ngClass]="{
        readonly: !canCreate,
        'first-term-exp': firstTermExpanded,
        'second-term-exp': secondTermExpanded
      }"
      aria-label="Оценки на учениците"
    >
      <col />
      <colgroup span="2"></colgroup>
      <colgroup span="2"></colgroup>
      <col *ngIf="showFinalGrades" />
      <thead>
        <tr>
          <th rowspan="2" scope="col">Ученик</th>
          <th
            class="text-center px-1 sm:px-2"
            [attr.colspan]="breakpointService.sm || firstTermExpanded ? 6 : 1"
            [attr.rowspan]="breakpointService.sm || firstTermExpanded ? 1 : 2"
            (click)="expandFirstTerm()"
            scope="colgroup"
          >
            <fa-icon *ngIf="!firstTermExpanded" class="text-primary sm:hidden" [icon]="fasPlusSquare"></fa-icon>
            <span class="inline sm:hidden" [ngClass]="{ 'text-vertical-rl whitespace-nowrap': !firstTermExpanded }">
              I срок
            </span>
            <span class="hidden sm:inline">Първи срок</span>
          </th>
          <th
            class="text-center px-1 sm:px-2"
            [attr.colspan]="breakpointService.sm || secondTermExpanded ? 6 : 1"
            [attr.rowspan]="breakpointService.sm || secondTermExpanded ? 1 : 2"
            (click)="expandSecondTerm()"
            scope="colgroup"
          >
            <fa-icon *ngIf="!secondTermExpanded" class="text-primary sm:hidden" [icon]="fasPlusSquare"></fa-icon>
            <span class="inline sm:hidden" [ngClass]="{ 'text-vertical-rl whitespace-nowrap': !secondTermExpanded }">
              II срок
            </span>
            <span class="hidden sm:inline">Втори срок</span>
          </th>
          <th *ngIf="showFinalGrades" rowspan="2" class="text-center px-1 sm:px-2" scope="col">
            <span class="text-vertical-rl sm:text-horizontal-tb">Годишна</span>
          </th>
        </tr>
        <tr>
          <th class="grade-cell first-term-only" scope="col">IX</th>
          <th class="grade-cell first-term-only" scope="col">X</th>
          <th class="grade-cell first-term-only" scope="col">XI</th>
          <th class="grade-cell first-term-only" scope="col">XII</th>
          <th class="grade-cell first-term-only" scope="col">I,II</th>
          <th class="grade-cell first-term-only" scope="col">
            <span class="inline sm:hidden">Ср</span>
            <span class="hidden sm:inline">Срочна</span>
          </th>
          <th class="grade-cell second-term-only" scope="col">II</th>
          <th class="grade-cell second-term-only" scope="col">III</th>
          <th class="grade-cell second-term-only" scope="col">IV</th>
          <th class="grade-cell second-term-only" scope="col">V</th>
          <th class="grade-cell second-term-only" scope="col">VI,VII</th>
          <th class="grade-cell second-term-only" scope="col">
            <span class="inline sm:hidden">Ср</span>
            <span class="hidden sm:inline">Срочна</span>
          </th>
        </tr>
      </thead>
      <tbody *ngFor="let student of studentsWithGrades">
        <tr>
          <td *ngIf="student.showInfoLink" scope="row">
            <a
              [routerLink]="[
                '../../../../student-info',
                this.data.classBookId,
                student.personId,
                'student-book',
                this.data.classBookId
              ]"
              class="text-primary"
            >
              {{ student.classNumber != null ? student.classNumber.toString() + '.' : '' }}

              {{ student.firstName }}
              {{ student.middleName }}
              {{ student.lastName }}

              <span *ngIf="student.abnormalStatus" class="sb-badge">
                {{ student.abnormalStatus }}
              </span>
            </a>
          </td>
          <td *ngIf="!student.showInfoLink" scope="row">
            {{ student.classNumber != null ? student.classNumber.toString() + '.' : '' }}

            {{ student.firstName }}
            {{ student.middleName }}
            {{ student.lastName }}

            <span *ngIf="student.abnormalStatus" class="sb-badge">
              {{ student.abnormalStatus }}
            </span>
          </td>
          <td class="grade-cell first-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesSep"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell first-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesOct"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell first-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesNov"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell first-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesDec"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell first-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesJan"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell bg-sky-50">
            <sb-grade-link
              *ngFor="let grade of student.firstTermTermGrades"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
            <sb-grade-link
              *ngIf="
                canCreateForecastGrade &&
                student.firstTermForecastGrade &&
                !student.isFirstTermGradeless &&
                !student.isRemoved
              "
              [grade]="student.firstTermForecastGrade"
              [isForecast]="true"
              (click)="addForecastGrade(student.personId, student.firstTermForecastGrade)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell second-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesFeb"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell second-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesMar"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell second-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesApr"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell second-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesMay"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell second-term-only">
            <sb-grade-link
              *ngFor="let grade of student.gradesJun"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
          </td>
          <td class="grade-cell bg-sky-50">
            <sb-grade-link
              *ngFor="let grade of student.secondTermTermGrades"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
            <sb-grade-link
              *ngIf="
                canCreateForecastGrade &&
                student.secondTermForecastGrade &&
                !student.isSecondTermGradeless &&
                !student.isRemoved
              "
              [grade]="student.secondTermForecastGrade"
              [isForecast]="true"
              (click)="addForecastGrade(student.personId, student.secondTermForecastGrade)"
            ></sb-grade-link>
          </td>
          <td *ngIf="showFinalGrades" class="grade-cell bg-sky-50">
            <sb-grade-link
              *ngFor="let grade of student.finalGrades"
              [grade]="grade"
              [isSelected]="grade.gradeId === selectedGradeId"
              [subjectTypeIsProfilingSubject]="data.curriculum.subjectTypeIsProfilingSubject"
              (click)="selectStudentGrade(student.personId, grade.gradeId)"
            ></sb-grade-link>
            <sb-grade-link
              *ngIf="
                canCreateForecastGrade && student.finalForecastGrade && !student.isFinalGradeless && !student.isRemoved
              "
              [grade]="student.finalForecastGrade"
              [isForecast]="true"
              (click)="addForecastGrade(student.personId, student.finalForecastGrade)"
            ></sb-grade-link>
          </td>
        </tr>
        <tr *ngIf="selectedStudentPersonId === student.personId">
          <td [attr.colspan]="breakpointService.sm ? 14 : 9" class="relative bg-yellow-50" [class.h-16]="loadingGrade">
            <mat-spinner
              *ngIf="loadingGrade"
              [diameter]="40"
              class="absolute top-1/2 left-1/2 -mt-5 -ml-5"
            ></mat-spinner>
            <div *ngIf="!loadingGrade && selectedGrade" class="sm:flex">
              <div class="sm:grow">
                <div>
                  <span class="block sm:inline whitespace-nowrap">
                    <fa-icon [icon]="fasPencilAlt"></fa-icon>
                    Оценка
                    <span [ngSwitch]="selectedGrade.category" class="font-bold">
                      <span *ngSwitchCase="GRADE_CATEGORY_DECIMAL">
                        "{{ selectedGrade.decimalGrade | sbDecimalGradeName }} ({{
                          selectedGrade.decimalGrade | sbDecimalGradeNumber
                        }})"
                      </span>
                      <span *ngSwitchCase="GRADE_CATEGORY_QUALITATIVE">
                        "{{ selectedGrade.qualitativeGrade | sbQualitativeGradeName }}"
                      </span>
                      <span *ngSwitchCase="GRADE_CATEGORY_SPECIAL_NEEDS">
                        "{{ selectedGrade.specialGrade | sbSpecialGradeName }}"
                      </span>
                    </span>
                  </span>
                  {{ ' ' }}
                  <span class="block sm:inline whitespace-nowrap">
                    по
                    <fa-icon [icon]="fasBookOpen"></fa-icon>
                    <span class="font-bold">{{ selectedGrade.subjectName }} / {{ selectedGrade.subjectTypeName }}</span>
                  </span>
                  {{ ' ' }}
                  <span class="block sm:inline whitespace-nowrap">
                    на
                    <fa-icon [icon]="fasCalendarAlt"></fa-icon>
                    <span class="font-bold">{{ selectedGrade.date | sbDate }}</span>
                  </span>
                </div>
                <div class="text-xs italic">
                  Вид:
                  <span class="font-bold">{{ selectedGrade.type | sbGradeTypeName }}</span>
                </div>
                <div class="text-xs italic">
                  <span class="inline sm:hidden">Създ. от</span>
                  <span class="hidden sm:inline">Създадено от</span>
                  <span class="font-bold">
                    {{ selectedGrade.createdBySysUserFirstName }} {{ selectedGrade.createdBySysUserLastName }}
                  </span>
                  на
                  <span class="font-bold">{{ selectedGrade.createDate | sbDateTime }}</span>
                </div>
                <div *ngIf="selectedGrade.comment" class="text-xs italic">
                  Коментар:
                  <ng-container *ngIf="selectedGrade.comment.indexOf('\n') !== -1"><br /></ng-container>
                  <span class="font-bold whitespace-pre-line">{{ selectedGrade.comment }}</span>
                </div>
                <span class="block sm:inline whitespace-nowrap">
                  <fa-icon [icon]="fasEye"></fa-icon>
                  Прочетено от родител:
                  <span class="font-bold">{{ selectedGrade.isReadFromParent ? 'да' : 'не' }}</span>
                </span>
              </div>

              <div>
                <button
                  *ngIf="selectedGrade.canRemove || (selectedGrade.canUndo && (undoExpired$ | async) === false)"
                  mat-raised-button
                  class="mt-2 sm:mt-0"
                  color="warn"
                  type="button"
                  (click)="removeSelectedGrade()"
                  [disabled]="removingGrade"
                >
                  <fa-icon
                    [icon]="removingGrade ? fasSpinnerThird : fasTrashAlt"
                    [spin]="removingGrade"
                    size="lg"
                  ></fa-icon>
                  <span>Премахни</span>
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</ng-container>
