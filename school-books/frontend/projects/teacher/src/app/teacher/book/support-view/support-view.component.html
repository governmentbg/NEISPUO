<form [formGroup]="form" autocomplete="off" novalidate>
  <sb-tab-card>
    <ng-container card-title>
      {{ data.support == null ? 'Създаване на подкрепа' : 'Редакция на подкрепа' }}
    </ng-container>
    <sb-editor-panel
      card-buttons
      [editBtnHidden]="!canEdit"
      [isNew]="data.support == null"
      (save)="onSave($event)"
      (editableChange)="editable = $event"
    >
      <button
        *ngIf="canRemove"
        disabled-mode-buttons
        mat-raised-button
        color="warn"
        type="button"
        (click)="onRemove()"
        [disabled]="removing"
      >
        <fa-icon [icon]="removing ? fasSpinnerThird : fasTrashAlt" [spin]="removing" size="lg"></fa-icon>
        <span class="hidden sm:inline">Премахни</span>
      </button>
    </sb-editor-panel>
    <ng-container card-body>
      <sb-banner type="warning" *ngIf="form.value.studentIds.length" class="mb-3" type="warning">
        Подкрепата е видима и в дневника на родителя/ученика.
      </sb-banner>
      <div class="sm:grid grid-cols-2 gap-x-4 mb-2">
        <sb-nom-select
          class="col-span-full"
          label="Ученици"
          formControlName="studentIds"
          [nomService]="classBookStudentNomsService"
          [showAllGroup]="true"
          [multiple]="true"
        ></sb-nom-select>

        <sb-nom-select
          class="col-start-1 col-span-full"
          label="Вид подкрепа"
          formControlName="supportDifficultyTypeIds"
          [nomService]="supportDifficultyTypeNomsService"
          [multiple]="true"
        ></sb-nom-select>

        <sb-textarea-field
          class="col-start-1 col-span-full"
          label="Цел"
          formControlName="description"
          [textareaMaxSize]="10000"
        ></sb-textarea-field>

        <sb-textarea-field
          class="col-start-1 col-span-full"
          label="Очакван резултат"
          formControlName="expectedResult"
          [textareaMaxSize]="10000"
        ></sb-textarea-field>

        <sb-date-field label="Краен срок" formControlName="endDate"></sb-date-field>

        <sb-nom-select
          class="col-start-1 col-span-full"
          label="Екип"
          formControlName="teacherIds"
          [nomService]="instTeacherNomsService"
          [multiple]="true"
        ></sb-nom-select>
      </div>

      <sb-card-section class="col-span-full">Дейности</sb-card-section>

      <sb-banner type="info" *ngIf="data.support == null">
        Трябва да запишете подкрепата, за да може да добавите дейности
      </sb-banner>

      <ng-container *ngIf="data.support != null">
        <button
          *ngIf="canEdit"
          (click)="openAddOrUpdateActivityDialog(null)"
          [disabled]="editable"
          mat-raised-button
          color="primary"
          aria-label="Нова дейност"
          type="button"
          class="mb-2.5"
        >
          <fa-icon [icon]="fasPlus" size="lg"></fa-icon>
          <span>Нова дейност</span>
        </button>
        <sb-table
          [dataSource]="dataSource"
          [displayedColumns]="
            canEdit
              ? ['action', 'activityTypeDesc', 'date', 'target', 'result']
              : ['activityTypeDesc', 'date', 'target', 'result']
          "
        >
          <ng-container cdkColumnDef="action">
            <th cdk-header-cell *cdkHeaderCellDef></th>
            <td cdk-cell *cdkCellDef="let row" class="sb-table-action">
              <button
                aria-label="Детайли"
                (click)="openAddOrUpdateActivityDialog(row.supportActivityId)"
                [disabled]="editable"
                class="sb-link-btn"
                type="button"
              >
                <fa-icon [icon]="fasPencil"></fa-icon>
              </button>
              <button
                (click)="onRemoveActivity(row.supportActivityId)"
                [disabled]="editable || removingAct[row.supportActivityId]"
                aria-label="Изтрий"
                class="sb-link-btn"
                type="button"
              >
                <fa-icon
                  [icon]="removingAct[row.supportActivityId] ? fasSpinnerThird : fasTrashAlt"
                  [spin]="removingAct[row.supportActivityId]"
                  size="lg"
                ></fa-icon>
              </button>
            </td>
          </ng-container>

          <ng-container cdkColumnDef="activityTypeDesc">
            <th cdk-header-cell *cdkHeaderCellDef>Дейност</th>
            <td cdk-cell *cdkCellDef="let row">{{ row.activityTypeDesc }}</td>
          </ng-container>

          <ng-container cdkColumnDef="date">
            <th cdk-header-cell *cdkHeaderCellDef>Дата</th>
            <td cdk-cell *cdkCellDef="let row">{{ row.date | sbDate }}</td>
          </ng-container>

          <ng-container cdkColumnDef="target">
            <th cdk-header-cell *cdkHeaderCellDef>Цел</th>
            <td cdk-cell *cdkCellDef="let row">
              <span class="whitespace-pre-line">{{ row.target }}</span>
            </td>
          </ng-container>

          <ng-container cdkColumnDef="result">
            <th cdk-header-cell *cdkHeaderCellDef>Резултат</th>
            <td cdk-cell *cdkCellDef="let row">
              <span class="whitespace-pre-line">{{ row.result }}</span>
            </td>
          </ng-container>
        </sb-table>
      </ng-container>
    </ng-container>
  </sb-tab-card>
</form>
