<div class="azure-sync-organization-table">
    <div class="azure-sync-organization-table-flex">
        <div class="d-flex align-items-center justify-content-between w-100">
            <div class="d-flex align-items-center">
                <label for="yearSelect" class="me-2">{{ CONSTANTS.PRIMENG_LABEL_SELECT_YEARS | translate }}</label>
                <div class="year-select-group me-3">
                    <p-multiSelect
                        id="yearSelect"
                        [options]="AZURE_SYNC_TABLES_CONFIG.SELECTABLE_YEARS"
                        [(ngModel)]="selectedYears"
                        (onChange)="onYearSelectionChange($event.value)"
                        [placeholder]="CONSTANTS.PRIMENG_LABEL_SELECT_YEARS | translate"
                        optionLabel="label"
                        optionValue="value"
                    ></p-multiSelect>
                    <button
                        pButton
                        type="button"
                        icon="pi pi-refresh"
                        class="p-button"
                        (click)="reloadActiveYear()"
                        [disabled]="loading"
                        pTooltip="{{ CONSTANTS.PRIMENG_TITLE_RELOAD_ACTIVE_YEAR | translate }}"
                        tooltipPosition="top"
                    ></button>
                </div>
            </div>
            <div class="d-flex align-items-center justify-content-end flex-grow-1">
                <p-multiSelect
                    [dropdownIcon]="'pi pi-cog'"
                    [filter]="false"
                    [displaySelectedLabel]="false"
                    [defaultLabel]="CONSTANTS.PRIMENG_MULTISELECT_LABEL_PLACEHOLDER | translate"
                    [options]="optionallyVisibleColumns$ | async"
                    [emptyMessage]="CONSTANTS.PRIMENG_MULTISELECT_LABEL_EMPTY | translate"
                    [(ngModel)]="selectedOptionalColumns"
                    (onChange)="onColumnChoiceChange($event)"
                    appendTo="body"
                    class="me-2"
                ></p-multiSelect>
            </div>
        </div>
        <div class="table-scroll-wrapper">
            <p-table
                #table
                [columns]="visibleColumns$ | async"
                [value]="mergedData"
                [paginator]="true"
                [rows]="AZURE_SYNC_TABLES_CONFIG.DEFAULT_ROWS_COUNT"
                [rowsPerPageOptions]="AZURE_SYNC_TABLES_CONFIG.ROWS_PER_PAGE_OPTIONS"
                [rowTrackBy]="trackByOrganizationID"
                class="p-datatable-sm fixed-table"
                [loading]="loading"
            >
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th
                            *ngFor="let col of columns"
                            [ngClass]="'col-' + col.field"
                            [pSortableColumn]="col?.notSortable ? '' : col.field"
                        >
                            {{ col.header }}
                            <p-sortIcon *ngIf="!col?.notSortable" [field]="col.field"></p-sortIcon>
                        </th>
                    </tr>
                    <tr>
                        <th *ngFor="let col of columns" [ngClass]="'col-' + col.field">
                            <p-dropdown
                                *ngIf="col.filter?.type === 'select'"
                                [options]="col.filter?.selectionOptions"
                                [ngModel]="table.filters[col.field]?.value"
                                (onChange)="table.filter($event.value, col.field, col.filter?.operator)"
                                [placeholder]="CONSTANTS.PRIMENG_DROPDOWN_PLACEHOLDER | translate"
                                optionLabel="label"
                                optionValue="value"
                                appendTo="body"
                            >
                                <ng-template let-option pTemplate="selectedItem">
                                    <span>{{ option.label | translate }}</span>
                                </ng-template>
                                <ng-template let-option pTemplate="item">
                                    <span>{{ option.label | translate }}</span>
                                </ng-template>
                            </p-dropdown>
                            <p-calendar
                                *ngIf="col.filter?.type === 'date'"
                                appendTo="body"
                                [monthNavigator]="true"
                                [yearNavigator]="true"
                                [yearRange]="'2018:' + currentYear"
                                dateFormat="yy-mm-dd"
                                firstDayOfWeek="1"
                                [showButtonBar]="true"
                                [dataType]="'date'"
                                (onSelect)="table.filter($event, col.field, col.filter?.operator)"
                                (onClearClick)="onDateClear(col.field, col.filter?.operator)"
                                [placeholder]="CONSTANTS.PRIMENG_DROPDOWN_PLACEHOLDER | translate"
                            ></p-calendar>
                            <input
                                *ngIf="col.filter?.type === 'text'"
                                class="filter-text"
                                pInputText
                                type="text"
                                [placeholder]="CONSTANTS.PRIMENG_INPUT_PLACEHOLDER | translate"
                                (input)="table.filter($event.target.value, col.field, col.filter?.operator)"
                                [ngModel]="table.filters[col.field]?.value"
                            />
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row let-columns="columns">
                    <tr *ngIf="!loadingError">
                        <td
                            *ngFor="let col of columns"
                            [ngClass]="'col-' + col.field"
                            [ngStyle]="{ 'text-align': col.field === 'options' ? 'center' : '' }"
                        >
                            <ng-container [ngSwitch]="col.field">
                                <ng-container *ngSwitchCase="'options'">
                                    <button
                                        pButton
                                        type="button"
                                        icon="pi pi-undo"
                                        class="p-button-sm p-button-primary"
                                        [disabled]="!isRestartWorkflowButtonEnabled(row.status, row.retryAttempts)"
                                        (click)="restartWorkflow(row.organizationID)"
                                        pTooltip="{{ CONSTANTS.PRIMENG_TITLE_WORKFLOW_RESTART | translate }}"
                                        tooltipPosition="left"
                                    ></button>
                                </ng-container>
                                <ng-container *ngSwitchCase="'status'">
                                    <span>{{
                                        getEnumLabel(col.filter?.selectionOptions, row.status) | translate
                                    }}</span>
                                </ng-container>
                                <ng-container *ngSwitchCase="'workflowType'">
                                    <span>{{
                                        getEnumLabel(col.filter?.selectionOptions, row.workflowType) | translate
                                    }}</span>
                                </ng-container>
                                <ng-container *ngSwitchCase="'createdOn'">
                                    <span>{{ row.createdOn | date: 'yyyy-MM-dd HH:mm:ss' }}</span>
                                </ng-container>
                                <ng-container *ngSwitchDefault>
                                    <span>{{ row[col.field] }}</span>
                                </ng-container>
                            </ng-container>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage" let-columns>
                    <tr>
                        <td [attr.colspan]="columns.length">
                            <div class="empty-message-center" [ngClass]="{ 'text-danger': loadingError }">
                                {{
                                    loadingError
                                        ? (loadingError | translate)
                                        : (CONSTANTS.PRIMENG_NO_DATA_FOUND | translate)
                                }}
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>
